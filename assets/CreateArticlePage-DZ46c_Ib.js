import{j as i,r as m,a as C,e as v,V as L}from"./index-YpBx47-g.js";import{u as j,c as F,a as S,b as x}from"./index.esm-COdbc9kr.js";import{a as y}from"./authSelectors-BgHEYK6w.js";import{c as T}from"./articlesApi-B2fcCESn.js";const I="_form_1wv15_1",N="_titleLabel_1wv15_19",U="_fileLabel_1wv15_29",R="_textareaLabel_1wv15_38",$="_camera_1wv15_47",A="_fileInput_1wv15_66",E="_input_1wv15_69",O="_textarea_1wv15_38",M="_errored_1wv15_99",q="_error_1wv15_99",D="_button_1wv15_108",c={form:I,titleLabel:N,fileLabel:U,textareaLabel:R,camera:$,fileInput:A,input:E,textarea:O,errored:M,error:q,button:D},V=({error:e,onChange:t,photoUrl:l})=>{const a=r=>{const n=r.target.files[0];if(n){if(n.size>2097152){alert("The file is too large. Maximum 2MB.");return}t&&t(n)}};return i.jsxs("label",{className:c.fileLabel,htmlFor:"upload-photo",children:[i.jsx("img",{width:361,height:233,id:"photo-preview",src:l,alt:"Click to upload",className:`${c.camera} ${e?c.errored:""}`}),i.jsx("input",{name:"image",type:"file",id:"upload-photo",accept:"image/*",className:c.fileInput,onChange:a}),i.jsx("span",{className:c.error,children:e||" "})]})},k=({touched:e,error:t,value:l,onChange:a})=>{const r=m.useRef(null);return m.useEffect(()=>{const n=r.current;if(!n)return;const u=n.clientHeight,o=()=>{n.style.height="auto";const d=Math.max(n.scrollHeight,u);n.style.height=`${d}px`};return n.addEventListener("input",o),()=>{n.removeEventListener("input",o)}},[]),i.jsxs("label",{className:c.textareaLabel,children:[i.jsx("textarea",{name:"text",ref:r,id:"article-text",placeholder:"Enter a text",className:`${c.textarea} ${e&&t?c.errored:""}`,value:l,onChange:n=>a(n.target.value),style:{resize:"none",overflow:"hidden"}}),i.jsx("span",{className:c.error,children:e&&t?t:" "})]})},P=({touched:e,error:t,value:l,onChange:a})=>{const r=m.useRef(null),n=()=>{const o=r.current;requestAnimationFrame(()=>{o.selectionStart=o.selectionEnd=o.value.length,o.scrollLeft=o.scrollWidth})},u=()=>{const o=r.current;o.scrollLeft=0};return i.jsxs("label",{className:c.titleLabel,htmlFor:"titleInput",children:["Article Title",i.jsx("input",{name:"title",ref:r,type:"text",id:"titleInput",className:`${c.input} ${e&&t?c.errored:""}`,placeholder:"Enter the title",onFocus:n,onBlur:u,value:l,onChange:o=>a(o.target.value)}),i.jsx("span",{className:c.error,children:e&&t?t:" "})]})},z=async e=>{const t=new FormData;return t.append("file",e),t.append("upload_preset","article_images"),(await(await fetch("https://api.cloudinary.com/v1_1/dlgcrdtgc/image/upload",{method:"POST",body:t})).json()).secure_url},B=async e=>e?await z(e):null,H=e=>{const t=e.match(/[^.!?]+[.!?]/);if(t){const l=t[0].trim();if(l.length>=10)return l}return e.length>50?e.slice(0,50).trim()+"...":e.trim()},J=(e,t)=>{const l=m.useRef(null);m.useEffect(()=>(l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{e()},t),()=>clearTimeout(l.current)),[e,t])};function W(e,t,l=1500){const[a,r]=m.useState(()=>{try{const u=localStorage.getItem(e);return u!==null?JSON.parse(u):t}catch{return t}}),n=m.useCallback(()=>{try{localStorage.setItem(e,JSON.stringify(a))}catch(u){console.log(u)}},[e,a]);return J(n,l),[a,r]}const p="data:image/svg+xml,%3csvg%20width='391'%20height='280'%20viewBox='0%200%20391%20280'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20width='391'%20height='280'%20fill='%239F9F9F'/%3e%3cpath%20d='M214.371%20146.212C214.371%20154.788%20206.099%20161.74%20195.897%20161.74C185.694%20161.74%20177.423%20154.788%20177.423%20146.212C177.423%20137.635%20185.694%20130.683%20195.897%20130.683C206.099%20130.683%20214.371%20137.635%20214.371%20146.212Z'%20stroke='%23070707'/%3e%3cpath%20d='M147.864%20167.625L147.864%20129.776C147.864%20123.416%20153.998%20118.26%20161.565%20118.26C166.755%20118.26%20171.499%20115.795%20173.82%20111.893L176.925%20106.673C179.494%20102.354%20184.747%2099.625%20190.492%2099.625L201.301%2099.625C207.047%2099.6251%20212.299%20102.354%20214.868%20106.673L217.973%20111.893C220.294%20115.795%20225.038%20118.26%20230.228%20118.26C237.795%20118.26%20243.929%20123.416%20243.929%20129.776V167.625C243.929%20174.667%20237.138%20180.375%20228.761%20180.375H163.032C154.655%20180.375%20147.864%20174.667%20147.864%20167.625Z'%20stroke='%23070707'/%3e%3c/svg%3e",Z=e=>{const t=C(y),[l,a]=W("articleDraft",{title:"",text:"",image:null}),[r,n]=m.useState(p);m.useEffect(()=>()=>{r&&URL.revokeObjectURL(r)},[r]);const u=j({initialValues:l,validationSchema:F({title:x().required("Title is required").min(5,"Title must be at least 5 characters").max(100,"Title must be at most 100 characters"),text:x().required("Text is required").min(100,"Text must be at least 100 characters"),image:S().required("Image is required").test("fileSize","Maximum file size is 2MB",s=>!s||s&&s.size<=2*1024*1024).test("fileType","Only jpg and png images are allowed",s=>!s||s&&["image/jpeg","image/png"].includes(s.type))}),onSubmit:async(s,{setSubmitting:h,setErrors:_})=>{const f=await B(s.image);if(!f){_({image:"Failed to upload image. Please try again."}),h(!1);return}const w=H(s.text),b={img:f,title:s.title,desc:w,article:s.text,rate:0,ownerId:t,date:new Date().toISOString()};await e(b),a({title:"",text:"",image:null}),n(p),h(!1)}});return{formik:u,previewUrl:r,handleFileChange:s=>{if(!s){n(p),u.setFieldValue("image",null);return}r&&URL.revokeObjectURL(r);const h=URL.createObjectURL(s);n(h),u.setFieldValue("image",s)},handleTitleChange:s=>{a(h=>({...h,title:s}))},handleTextChange:s=>{a(h=>({...h,text:s}))}}},G=()=>{const[e,t]=m.useState(!1);return{create:async a=>{t(!0);try{return(await T(a)).data}catch(r){throw console.error("Failed to create article:",r),r}finally{t(!1)}},isLoading:e}},K=()=>{const{create:e,isLoading:t}=G(),l=v(),{formik:a,previewUrl:r,handleFileChange:n,handleTitleChange:u,handleTextChange:o}=Z(async d=>{try{const s=(await e(d)).data._id;l(`/articles/${s}`)}catch(g){L.error("An error occurred when creating an article!"),console.error(g)}});return i.jsxs("form",{className:c.form,onSubmit:a.handleSubmit,children:[i.jsx(V,{onChange:n,photoUrl:r,error:a.errors.image}),i.jsx(P,{value:a.values.title,onChange:d=>{a.setFieldValue("title",d),u(d)},error:a.errors.title,touched:a.touched.title}),i.jsx(k,{value:a.values.text,onChange:d=>{a.setFieldValue("text",d),o(d)},error:a.errors.text,touched:a.touched.text}),i.jsx("button",{disabled:a.isSubmitting||t,type:"submit",className:c.button,children:"Publish Article"})]})},Q="_title_10ppv_1",X="_section_10ppv_6",re=()=>i.jsxs("section",{className:`container ${X}`,children:[i.jsx("h1",{className:Q,children:"Create an article"}),i.jsx(K,{})]});export{re as default};
